<!DOCTYPE html>
<html>
  <head>
    <title>Typing</title>
    <style type="text/css">
      #root {
        height: 300px;
        width: 300px;
        margin: 10px;
        border: 1px dashed red;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

    <script lang="javascript">
        const questions =  ["hello", "hogehoge"];
        counter=0;

        function refreshQuestion(){
            qFin=""
            qLeast = questions[counter];

        }

        function firstStep(event){
            // Remove First Listener
            $.when(
                document.body.removeEventListener('keydown',firstStep),
                ctdMes(3)
            ).done(function(){
                $.when(
                    refreshQuestion(),
                    document.body.addEventListener('keydown',startGame),
                    document.getElementById('question').innerHTML = qLeast,
                    countDownTimer(60),
                ).done(function(){
                    document.body.removeEventListener('keydown',startGame),
                    alert("Finished!!")
                    document.getElementById('timer').innerHTML =""
                })
              })
            }
            function checkChar(chr){
                if ( chr === qLeast.split('')[0]){
                    console.log("ok")
                    qFin += qLeast.split('')[0]
                    qLeast = qLeast.slice(1);
                }
            }

            function startGame(event){
                $.when(
                    checkChar(event.key)
                ).done(function(){
                    if(qLeast.length === 0 ){
                        counter++
                        refreshQuestion();
                    }
                    document.getElementById('question').innerHTML = "<span style='color:red'>" + qFin + "</span>" + qLeast;
                })
                }

            function countDownTimer(timer){
                document.getElementById('timer').innerHTML = timer;
                var d = $.Deferred();
                var timerID = setInterval(function(){
                    if(timer == 1){
                        clearInterval(timerID);
                        d.resolve();
                    }else{
                        timer--;
                        document.getElementById('timer').innerHTML = timer;
                    }
                },1000)
                return d.promise();
            }

        $(function(){
            document.body.addEventListener('keydown',firstStep);
        })

        function initializeFunction(){
            return new Promise((resolve, reject) => {
                setTimeout( () => {
                    console.log('a');
                    resolve();
                },1000)
            })
        }

        function mainFunction(){
            return new Promise ( (resolve, reject) => {
                setTimeout( () => {
                console.log('b');
                resolve();

                },1000)
            })
        }

      async function init(){
      // 開始処理部分
        //StartCountDown
            await initializeFunction();
            await mainFunction();
      // 処理部分
        // EventHandler

        //  Countdown

      // 終了処理部分

        // Calculate
        console.log("mount!")
        document.body.addEventListener('keydown',
        event => {
            if(event.code === 'Space' && startFlag === false ){
                startFlag = true;
                 ctdMes(3);
            }
            console.log(event)

        })
      }

      // CountDown

      // For async function
      function asyncMes(mes, ms ) {
          return new Promise ( resolve =>
          setTimeout( () => {
              printMessage(mes);
              resolve();
          },ms))
      }

      // For async Main function
      function ctdMes(startNum){
          return new Promise( async (resolve,reject) => {

          printMessage(startNum--);
          while(startNum >0 ){
              //console.log(startNum)
              const res = await asyncMes(startNum, 1000);
              startNum--;
          }
              const res1 = await asyncMes("", 1000);
            await resolve();
          })

      }

      function printMessage(mes){
          document.getElementById('countdown').innerHTML = mes;
      }
    </script>
  </head>
  <body>
    <div id="root">
      <div id="countdown">スペースバーを押すと始まります。</div>
      <div id="question"></div>
      <div id="timer"></div>
    </div>
  </body>
</html>
